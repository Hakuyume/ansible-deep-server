- hosts: all
  environment:
    PATH: "{{ prefix }}/bin:{{ ansible_env.PATH }}"
    PYTHONUSERBASE: "{{ prefix }}"
  vars:
    njobs: "{{ansible_processor_count * ansible_processor_cores * 2}}"
  roles:
    - cmake
    - python
    - opencv
    - cuda
  tasks:
    - name: make git/completion
      file:
        path: "{{ prefix }}/share/git/completion"
        state: directory
    - name: git-prompt
      get_url:
        url: https://raw.githubusercontent.com/git/git/master/contrib/completion/git-prompt.sh
        dest: "{{ prefix }}/share/git/completion"
    - name: tmux
      get_url:
        url: https://gist.githubusercontent.com/Hakuyume/e764018bc7dc2072dba43b02c7b489b9/raw/80c12398e45d2c66e871523d394273b78bba20bb/.tmux.conf
        dest: "{{ ansible_env.HOME }}"
    - name: bashrc
      blockinfile:
        path: "{{ ansible_env.HOME }}/.bashrc"
        block: |
          export LANG=en_US.utf8

          if [[ -z $TMUX ]]; then
             if $(tmux has-session); then
                 exec tmux attach
             else
                 exec tmux
             fi
          fi

          source {{ prefix }}/share/git/completion/git-prompt.sh
          PS1='[\u@\h \W$(__git_ps1)]\$ '

          export PYTHONIOENCODING=utf8
          if [[ -n $PYTHONVENV ]]; then
              source $PYTHONVENV/bin/activate
              pip install -U \
                  cython \
                  matplotlib \
                  mock \
                  nose \
                  pillow
              export MPLBACKEND=agg
          fi
          function venv(){
              local PYTHONVENV=$(mktemp --tmpdir -d XXXXXXXX)
              python3 -m venv --system-site-packages $PYTHONVENV
              PYTHONVENV=$PYTHONVENV bash
              rm -r $PYTHONVENV
          }
